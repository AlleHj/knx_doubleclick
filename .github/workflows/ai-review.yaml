name: Gemini Code Review
on:
  pull_request:
    types: [opened, reopened, ready_for_review, synchronize]
  issue_comment:
    types: [created]

jobs:
  gemini_review:
    runs-on: ubuntu-latest
    # Kör endast om det är en PR och inte en bot
    if: ${{ github.event.sender.type != 'Bot' && (github.event_name == 'pull_request' || github.event.issue.pull_request) }}
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - uses: actions/checkout@v4
      
      - name: "Run Gemini Code Review"
        uses: google-github-actions/run-gemini-cli@v0.2.1
        env:
          PR_NUMBER: ${{ github.event.pull_request.number || github.event.issue.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # Här använder vi din nyckel direkt
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: "gemini-1.5-pro"
          
          # Detta kommando körs mot koden
          prompt: |
            You are an expert code reviewer. Review the changes in this Pull Request.
            Focus on Home Assistant best practices and pythonic code.
            
            1. Summarize the changes.
            2. Look for bugs or blocking I/O operations in the event loop.
            3. Suggest improvements.
            
            Post your review as a comment on the Pull Request.
            
            DIFF TO REVIEW:
            $ {{ github.event.pull_request.diff_url }}
